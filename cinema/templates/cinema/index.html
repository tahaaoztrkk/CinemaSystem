{% load static %}
{% load custom_filters %}
<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CineMate</title>
    <link rel="stylesheet" href="{% static 'cinema/style.css' %}">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
</head>
<body>

    <nav class="navbar">
        <div class="logo">Cine<span class="highlight">Mate</span></div>
        <ul class="nav-links">
            <li><a href="#" onclick="showSection('home')">Main Page</a></li>
            
            {% if user.is_authenticated %}
                <li><a href="#" onclick="showSection('profile')">My Profile</a></li>
            {% endif %}
        </ul>
        <div class="auth-buttons">
            {% if user.is_authenticated %}
                <div class="user-info" style="display: inline-block; margin-right: 10px; color: white;">
                    <i class="fas fa-user-circle"></i> {{ user.username }}
                </div>
                <button id="logout-btn" class="cta-btn" style="background:#333;">Logout</button>
                <button id="login-btn" class="cta-btn" style="display:none;">Login</button>
            {% else %}
                <div class="user-info" style="display: inline-block; margin-right: 10px; color: white;">
                    <i class="fas fa-user-circle"></i> Guest
                </div>
                <button id="login-btn" class="cta-btn">Login</button>
                <button id="logout-btn" class="cta-btn" style="display:none;">Logout</button>
            {% endif %}
        </div>
    </nav>

    <header class="hero">
        <div class="hero-content">
            <h1>Watch Together, Stay Connected</h1>
            <p>Discover movies tailored to you with AI and book your tickets instantly.</p>
            <button class="cta-btn" onclick="document.getElementById('movies-grid').scrollIntoView();">Book Ticket</button>
        </div>
    </header>

    <div id="home-section">
        <main class="container">
            {% if user.is_authenticated %}
            <section class="recommendations">
                <h2><i class="fas fa-magic"></i> Recommended for You</h2>
                <div class="movie-grid" id="recommended-grid"></div>
            </section>
            {% endif %}
            <section class="all-movies">
                <h2>Movies in Theaters</h2>
                <div class="movie-grid" id="movies-grid"></div>
            </section>
        </main>
    </div>

    <div id="profile-section" class="container" style="display: none;">
        <h2>My Tickets</h2>
        <table class="data-table">
            <thead>
                <tr>
                    <th style="width: 60px;">Afi≈ü</th> <th>Movie</th>
                    <th>Date</th>
                    <th>Time</th>
                    <th>Seat</th>
                    <th>Price</th>
                    <th>Action</th>
                    <th>QR</th> <th>Action</th>
                </tr>
            </thead>
            <tbody id="user-tickets-body">
                {% for ticket in my_tickets %}
                <tr>
                    <td style="width: 50px; padding: 5px;">
    <div style="width: 40px; height: 60px; overflow: hidden; border-radius: 4px; border: 1px solid #444;">
        <img src="{{ ticket.session.movie.poster_url|default:'https://via.placeholder.com/100x150' }}" 
             alt="Afi≈ü"
             style="width: 100%; height: 100%; object-fit: cover; display: block;">
    </div>
</td>
                    
                    <td style="font-weight: bold; color: #e50914;">{{ ticket.session.movie.title }}</td>
                    <td>{{ ticket.session.start_time|date:"d M Y" }}</td> 
                    <td><span class="highlight">{{ ticket.session.start_time|date:"H:i" }}</span></td>
                    <td>{{ ticket.seat_number }}</td>
                    <td>{{ ticket.price }} TL</td>
                    
                    <td>
                        <button onclick="cancelTicket({{ ticket.booking_id }})" 
                                style="background-color: #333; color: white; border: 1px solid #555; padding: 5px 10px; border-radius: 4px; cursor: pointer; font-size: 0.8rem; transition: 0.3s;">
                            <i class="fas fa-trash"></i> Cancel
                        </button>
                    </td>

                    <td style="text-align: center;">
            <button onclick="showQR('{{ ticket|generate_qr }}', '{{ ticket.session.movie.title }}')" 
                    style="background: #f1c40f; border: none; padding: 5px 10px; border-radius: 4px; cursor: pointer; color: black; font-weight: bold;">
                <i class="fas fa-qrcode"></i> Show
            </button>
        </td>
                </tr>
                {% empty %}
                <tr>
                    <td colspan="7" style="text-align: center; color: #aaa; padding: 20px;">
                        You have no ticket yet.
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
        <div style="margin-top: 40px; padding: 20px; background: #221f1f; border-radius: 10px;">
            
            <h3><i class="fas fa-user-plus"></i> Add Friend</h3>
            <div style="margin: 15px 0; display: flex; gap: 10px;">
                <input type="text" id="friend-username" placeholder="Username (Ex: ali)" 
                       style="padding: 10px; border-radius: 5px; border: none; width: 250px;">
                <button onclick="sendFriendRequest()" class="cta-btn" style="padding: 10px 20px;">Send Request</button>
            </div>

            {% if friend_requests %}
            <div style="margin-bottom: 20px; background: #333; padding: 10px; border-radius: 5px;">
                <h4 style="color: #f1c40f; margin-bottom: 10px;">üîî Pending Requests</h4>
                <ul style="list-style: none; padding: 0;">
                    {% for req in friend_requests %}
                    <li style="display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #444; padding: 8px 0;">
                        <span><i class="fas fa-user"></i> <b>{{ req.from_user.name }}</b> want to add you.</span>
                        <div>
                            <button onclick="respondToRequest({{ req.id }}, 'accept')" style="background: green; color: white; border: none; padding: 5px 10px; cursor: pointer; border-radius: 3px;">Kabul Et</button>
                            <button onclick="respondToRequest({{ req.id }}, 'reject')" style="background: #e50914; color: white; border: none; padding: 5px 10px; cursor: pointer; border-radius: 3px;">Reddet</button>
                        </div>
                    </li>
                    {% endfor %}
                </ul>
            </div>
            {% endif %}

            <h3><i class="fas fa-users"></i> My Friends</h3>
            <ul style="list-style: none; padding: 0;">
                {% if current_app_user %}
                    {% for friend in current_app_user.friends.all %}
                        <li style="padding: 10px; border-bottom: 1px solid #333;">
                            <i class="fas fa-check-circle" style="color: green;"></i> {{ friend.name }}
                        </li>
                    {% empty %}
                        <li style="color: #777;">You have no friend.</li>
                    {% endfor %}
                {% else %}
                    <li>You should login</li>
                {% endif %}
            </ul>
        </div>
    </div>

    <div id="booking-modal" class="modal">
        <div class="modal-content" style="max-width: 600px;">
            <span class="close-btn">&times;</span>
            
            <div class="booking-header">
                <h2 id="modal-title">Movie Title</h2>
                <p id="modal-info" style="color:#aaa; font-size:0.9rem; margin-bottom:10px;">Details</p>
            </div>

            <div style="display:flex; justify-content:center; gap:10px; margin-bottom:20px;">
                <button class="cta-btn tab-btn active" onclick="switchTab('booking')">Book Ticket</button>
                <button class="cta-btn tab-btn" onclick="switchTab('reviews')" style="background:#333;">Reviews</button>
            </div>

            <div id="tab-booking" class="tab-content">
                <div class="session-selector">
                    <span>Select Session:</span>
                    <button class="time-btn active" onclick="selectSession('13:00', this)">13:00</button>
                    <button class="time-btn" onclick="selectSession('17:00', this)">17:00</button>
                </div>

                <div class="screen-container">
                    <div class="screen">SCREEN</div>
                </div>
                
                <div class="seats-container" id="seats-grid"></div>
                
                <div class="booking-footer">
                    <p class="text">Count: <span id="count">0</span> | Total: <span id="total">0</span> TL</p>
                    <button id="confirm-btn" class="cta-btn" style="width:100%; margin-top:10px;">Pay Now</button>
                </div>
            </div>

            <div id="tab-reviews" class="tab-content" style="display:none; text-align:left;">
                
                <div id="reviews-list" style="max-height: 200px; overflow-y: auto; margin-bottom: 20px; border-bottom: 1px solid #333;">
                    </div>

                <div class="add-review-box">
                    <h4 style="margin-bottom:10px;">Rate Movie:</h4>
                    <div class="star-rating" style="font-size: 24px; color: #f1c40f; cursor: pointer; margin-bottom: 10px;">
                        <span onclick="setRating(1)">‚òÖ</span>
                        <span onclick="setRating(2)">‚òÖ</span>
                        <span onclick="setRating(3)">‚òÖ</span>
                        <span onclick="setRating(4)">‚òÖ</span>
                        <span onclick="setRating(5)">‚òÖ</span>
                        <span id="rating-text" style="font-size: 14px; color: white; margin-left: 10px;">(0/5)</span>
                    </div>
                    <textarea id="review-comment" placeholder="How was the movie?" style="width:100%; padding:10px; background:#333; color:white; border:none; border-radius:5px;"></textarea>
                    <button onclick="submitReview()" class="cta-btn" style="width:100%; margin-top:10px;">Submit Review</button>
                </div>
            </div>

        </div>
    </div>
    <div id="login-modal" class="modal">
        <div class="modal-content" style="max-width: 300px; background-color: #1f2025; color: white;">
            <span class="close-login" style="float:right; cursor:pointer; font-size: 24px;">&times;</span>
            <h2 style="margin-bottom: 20px;">Login</h2>
            
            <input type="text" id="username" placeholder="Username" 
                   style="width:100%; padding:10px; margin:10px 0; background:#333; border:none; color:white; border-radius:4px;">
            
            <input type="password" id="password" placeholder="Password" 
                   style="width:100%; padding:10px; margin:10px 0; background:#333; border:none; color:white; border-radius:4px;">
            
            <button onclick="login()" class="cta-btn" style="width:100%; margin-top: 10px;">Login</button>
            
            <p style="margin-top: 15px; font-size: 0.8rem; color: #aaa;">
                Don't have an account? <a href="#" onclick="switchModal('register')" style="color: #e50914;">Register</a>
            </p>
        </div>
    </div>
    <div id="register-modal" class="modal">
        <div class="modal-content" style="max-width: 300px; background-color: #1f2025; color: white;">
            <span class="close-register" style="float:right; cursor:pointer; font-size: 24px;">&times;</span>
            <h2 style="margin-bottom: 20px;">Create Account</h2>
            
            <input type="text" id="reg-username" placeholder="Username" 
                   style="width:100%; padding:10px; margin:10px 0; background:#333; border:none; color:white; border-radius:4px;">
            
            <input type="email" id="reg-email" placeholder="Email Address" 
                   style="width:100%; padding:10px; margin:10px 0; background:#333; border:none; color:white; border-radius:4px;">

            <input type="password" id="reg-password" placeholder="Password" 
                   style="width:100%; padding:10px; margin:10px 0; background:#333; border:none; color:white; border-radius:4px;">
            
            <button onclick="register()" class="cta-btn" style="width:100%; margin-top: 10px; background-color: #46d369;">Register</button>
            
            <p style="margin-top: 15px; font-size: 0.8rem; color: #aaa;">
                Already have an account? <a href="#" onclick="switchModal('login')" style="color: #e50914;">Login</a>
            </p>
        </div>
    </div>

    <div id="chat-widget" style="position: fixed; bottom: 20px; right: 20px; z-index: 9999; font-family: sans-serif;">
    <button id="chat-toggle" style="background-color: #e50914; color: white; border: none; border-radius: 50%; width: 60px; height: 60px; cursor: pointer; box-shadow: 0 4px 8px rgba(0,0,0,0.3); font-size: 24px;">
        üí¨
    </button>

    <div id="chat-box" style="display: none; width: 350px; height: 450px; background: white; border-radius: 10px; box-shadow: 0 5px 15px rgba(0,0,0,0.3); flex-direction: column; overflow: hidden; margin-bottom: 80px;">
        
        <div style="background-color: #e50914; color: white; padding: 15px; font-weight: bold; display: flex; justify-content: space-between;">
            <span>üé¨ Cinema Assistant</span>
            <span id="close-chat" style="cursor: pointer;">‚úñ</span>
        </div>

        <div id="chat-messages" style="flex: 1; padding: 15px; overflow-y: auto; background-color: #f1f1f1; display: flex; flex-direction: column; gap: 10px;">
            <div style="align-self: flex-start; background: #e0e0e0; padding: 8px 12px; border-radius: 15px 15px 15px 0; max-width: 80%; color: #333;">
                Hello! Which movie would you like to watch today? üçø
            </div>
        </div>

        <div style="padding: 10px; background: white; border-top: 1px solid #ddd; display: flex;">
            <input type="text" id="user-input" placeholder="Type a message..." style="flex: 1; padding: 10px; border: 1px solid #ccc; border-radius: 20px; outline: none;">
            <button id="send-btn" style="background: #e50914; color: white; border: none; padding: 10px 15px; margin-left: 5px; border-radius: 50%; cursor: pointer;">‚û§</button>
        </div>
    </div>
</div>

<div id="qr-modal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 10000; justify-content: center; align-items: center;">
    <div style="background: white; padding: 20px; border-radius: 10px; text-align: center; max-width: 300px; position: relative;">
        
        <h3 id="qr-movie-title" style="color: black; margin-bottom: 15px;">Movie Title</h3>
        
        <img id="qr-image" src="" alt="Bilet QR" style="width: 200px; height: 200px;">
        
        <p style="color: #555; font-size: 12px; margin-top: 10px;">Scan at the counter.</p>
        
        <button onclick="document.getElementById('qr-modal').style.display='none'" 
                style="margin-top: 15px; background: #e50914; color: white; border: none; padding: 8px 20px; border-radius: 5px; cursor: pointer;">
            Kapat
        </button>
    </div>
</div>

<script>
    // QR Modal A√ßma Fonksiyonu
    function showQR(base64Image, movieTitle) {
        document.getElementById('qr-image').src = base64Image;
        document.getElementById('qr-movie-title').innerText = movieTitle;
        document.getElementById('qr-modal').style.display = 'flex';
    }
    
    // Dƒ±≈üarƒ± tƒ±klayƒ±nca kapat
    document.getElementById('qr-modal').onclick = function(e) {
        if(e.target === this) this.style.display = 'none';
    }
</script>

<script>
    const chatToggle = document.getElementById('chat-toggle');
    const chatBox = document.getElementById('chat-box');
    const closeChat = document.getElementById('close-chat');
    const sendBtn = document.getElementById('send-btn');
    const userInput = document.getElementById('user-input');
    const messagesArea = document.getElementById('chat-messages');

    // A√ß/Kapa ƒ∞≈ülemi
    chatToggle.addEventListener('click', () => {
        chatBox.style.display = chatBox.style.display === 'none' ? 'flex' : 'none';
        chatToggle.style.display = 'none'; // Kutuyu a√ßƒ±nca butonu gizle
    });

    closeChat.addEventListener('click', () => {
        chatBox.style.display = 'none';
        chatToggle.style.display = 'block';
    });

    // Mesaj Ekleme Fonksiyonu
    function addMessage(text, sender) {
        const div = document.createElement('div');
        div.textContent = text;
        div.style.padding = '8px 12px';
        div.style.maxWidth = '80%';
        div.style.wordWrap = 'break-word';
        
        if (sender === 'user') {
            div.style.alignSelf = 'flex-end';
            div.style.background = '#e50914';
            div.style.color = 'white';
            div.style.borderRadius = '15px 15px 0 15px';
        } else {
            div.style.alignSelf = 'flex-start';
            div.style.background = '#e0e0e0';
            div.style.color = '#333';
            div.style.borderRadius = '15px 15px 15px 0';
        }
        
        messagesArea.appendChild(div);
        messagesArea.scrollTop = messagesArea.scrollHeight; // En alta kaydƒ±r
    }

    // Backend'e ƒ∞stek G√∂nderme
    async function sendMessage() {
        const text = userInput.value.trim();
        if (!text) return;

        addMessage(text, 'user');
        userInput.value = '';

        // "Yazƒ±yor..." efekti eklenebilir buraya

        try {
            const response = await fetch('/api/chat/', { // URL'i urls.py'daki path ile e≈üle≈ütirin
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ message: text })
            });

            const data = await response.json();
            if (data.response) {
                addMessage(data.response, 'bot');
            } else {
                addMessage("Bir hata olu≈ütu.", 'bot');
            }
        } catch (error) {
            console.error('Hata:', error);
            addMessage("Baƒülantƒ± hatasƒ±!", 'bot');
        }
    }

    sendBtn.addEventListener('click', sendMessage);
    userInput.addEventListener('keypress', (e) => {
        if (e.key === 'Enter') sendMessage();
    });
</script>

    <script>
        const userFavoriteGenre = "{{ favorite_genre|default:''|escapejs }}";
        const movies = [
            {% for movie in movies_from_db %}
            {
                id: {{ movie.movie_id }},
                title: "{{ movie.title }}",
                genre: "{{ movie.genre }}",
                director: "{{ movie.director }}",
                rating: {{ movie.avg_rating|default:0|stringformat:".1f" }}, 
                price: 150,
                image: "{{ movie.poster_url|safe|default:'https://via.placeholder.com/300x450' }}"
                
            }{% if not forloop.last %},{% endif %}
            {% endfor %}
        ];

        
        // 2. DOLU KOLTUKLAR (GELƒ∞≈ûMƒ∞≈û VERSƒ∞YON)
        const dbBookings = [
            {% for b in bookings_json %}
            {
                movieId: {{ b.movie_id }},
                seatIndex: {{ b.seat_number }},
                time: "{{ b.time|date:'H:i' }}",
                isFriend: {{ b.is_friend|yesno:"true,false" }}, // Arkada≈ü mƒ±?
                ownerName: "{{ b.owner_name }}" // Kim almƒ±≈ü?
            }{% if not forloop.last %},{% endif %}
            {% endfor %}
        ];

        // 3. YORUMLAR (YENƒ∞)
        const dbReviews = [
            {% for review in reviews_from_db %}
            {
                movieId: {{ review.movie.movie_id }},
                user: "{{ review.user.name }}",
                rating: {{ review.rating }},
                comment: "{{ review.comment|escapejs }}",
                verified: {{ review.is_verified_purchase|yesno:"true,false" }}
            }{% if not forloop.last %},{% endif %}
            {% endfor %}
        ];
    </script>

    <script src="{% static 'cinema/script.js' %}?v=6"></script>
</body>
</html>